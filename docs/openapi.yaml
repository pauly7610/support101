openapi: 3.0.3
info:
  title: Support Intelligence Core API
  version: '3.0.0'
  description: |
    Full API for Support Intelligence Core (SIC) — LLM-powered customer support platform.
    Covers RAG (multi-model), document ingestion, agent framework (9 blueprints), HITL queue,
    governance & RBAC, multi-tenant management, webhooks, analytics, compliance,
    voice I/O (Whisper + TTS), LLM cost tracking, A2A protocol, and Prometheus metrics.
  contact:
    name: Support101
    url: https://github.com/pauly7610/support101
servers:
  - url: http://localhost:8000
    description: Local development
tags:
  - name: RAG
    description: Retrieval-Augmented Generation endpoints
  - name: Ingestion
    description: Document ingestion and vectorization
  - name: Agents
    description: Agent CRUD and execution
  - name: HITL
    description: Human-in-the-loop review queue
  - name: Governance
    description: Dashboard, RBAC, audit logging
  - name: Tenants
    description: Multi-tenant management
  - name: Webhooks
    description: Inbound webhooks (Zendesk, Slack, Jira, generic)
  - name: Analytics
    description: Escalation analytics
  - name: Compliance
    description: GDPR and CCPA endpoints
  - name: Observability
    description: Prometheus metrics
  - name: Voice
    description: Voice I/O (Whisper STT + OpenAI TTS)
  - name: Cost Tracking
    description: LLM cost tracking and budget management
  - name: A2A Protocol
    description: Agent-to-Agent interoperability (Google A2A spec)

paths:
  # ── RAG ──────────────────────────────────────────────────────
  /generate_reply:
    post:
      tags: [RAG]
      summary: Generate a support reply using RAG
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TicketContext'
      responses:
        '200':
          description: Generated reply with source citations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuggestedResponse'
        '429':
          $ref: '#/components/responses/RateLimited'

  # ── Ingestion ────────────────────────────────────────────────
  /ingest_documentation:
    post:
      tags: [Ingestion]
      summary: Ingest a document for vector search
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: PDF, MD, or TXT file
                chunk_size:
                  type: integer
                  minimum: 512
                  maximum: 2048
                  default: 1024
      responses:
        '200':
          description: Ingestion result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestResponse'
        '400':
          description: Invalid file type or chunk size
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          $ref: '#/components/responses/RateLimited'

  # ── Agents ───────────────────────────────────────────────────
  /v1/agents:
    post:
      tags: [Agents]
      summary: Create an agent from a blueprint
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAgentRequest'
      responses:
        '201':
          description: Agent created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentResponse'
    get:
      tags: [Agents]
      summary: List agents
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - name: blueprint_name
          in: query
          schema:
            type: string
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: List of agents
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AgentResponse'

  /v1/agents/{agent_id}:
    get:
      tags: [Agents]
      summary: Get agent details
      parameters:
        - $ref: '#/components/parameters/AgentId'
      responses:
        '200':
          description: Agent details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentResponse'
        '404':
          description: Agent not found
    delete:
      tags: [Agents]
      summary: Delete an agent
      parameters:
        - $ref: '#/components/parameters/AgentId'
      responses:
        '204':
          description: Agent deleted

  /v1/agents/{agent_id}/execute:
    post:
      tags: [Agents]
      summary: Execute an agent with input data
      parameters:
        - $ref: '#/components/parameters/AgentId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExecuteAgentRequest'
      responses:
        '200':
          description: Execution result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecutionResponse'

  /v1/agents/{agent_id}/state:
    get:
      tags: [Agents]
      summary: Get agent runtime state
      parameters:
        - $ref: '#/components/parameters/AgentId'
      responses:
        '200':
          description: Agent state
          content:
            application/json:
              schema:
                type: object

  /v1/agents/stats/overview:
    get:
      tags: [Agents]
      summary: Agent statistics overview
      parameters:
        - $ref: '#/components/parameters/TenantId'
      responses:
        '200':
          description: Agent stats
          content:
            application/json:
              schema:
                type: object

  /v1/blueprints:
    get:
      tags: [Agents]
      summary: List available agent blueprints
      responses:
        '200':
          description: List of blueprints
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BlueprintResponse'

  /v1/blueprints/{blueprint_name}:
    get:
      tags: [Agents]
      summary: Get blueprint details
      parameters:
        - name: blueprint_name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Blueprint details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BlueprintResponse'

  # ── HITL ─────────────────────────────────────────────────────
  /v1/hitl/queue:
    get:
      tags: [HITL]
      summary: Get HITL review queue
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - name: priority
          in: query
          schema:
            type: string
            enum: [critical, high, medium, low]
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, assigned, completed, cancelled]
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: Queue items
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      type: object
                  total:
                    type: integer

  /v1/hitl/queue/{request_id}:
    get:
      tags: [HITL]
      summary: Get a specific HITL request
      parameters:
        - $ref: '#/components/parameters/RequestId'
      responses:
        '200':
          description: Request details
          content:
            application/json:
              schema:
                type: object

  /v1/hitl/queue/{request_id}/assign:
    post:
      tags: [HITL]
      summary: Assign a request to a reviewer
      parameters:
        - $ref: '#/components/parameters/RequestId'
        - name: reviewer_id
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Assignment result
          content:
            application/json:
              schema:
                type: object

  /v1/hitl/queue/{request_id}/unassign:
    post:
      tags: [HITL]
      summary: Unassign a request
      parameters:
        - $ref: '#/components/parameters/RequestId'
      responses:
        '200':
          description: Unassignment result

  /v1/hitl/queue/{request_id}/respond:
    post:
      tags: [HITL]
      summary: Respond to a HITL request (approve/reject/edit)
      parameters:
        - $ref: '#/components/parameters/RequestId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [action]
              properties:
                action:
                  type: string
                  enum: [approve, reject, edit]
                response_text:
                  type: string
                feedback:
                  type: string
      responses:
        '200':
          description: Response recorded
          content:
            application/json:
              schema:
                type: object

  /v1/hitl/queue/{request_id}/cancel:
    post:
      tags: [HITL]
      summary: Cancel a HITL request
      parameters:
        - $ref: '#/components/parameters/RequestId'
        - name: reason
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Cancellation result

  /v1/hitl/reviewers:
    post:
      tags: [HITL]
      summary: Register a reviewer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [reviewer_id, name]
              properties:
                reviewer_id:
                  type: string
                name:
                  type: string
                specializations:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Reviewer registered

  /v1/hitl/reviewers/{reviewer_id}/availability:
    put:
      tags: [HITL]
      summary: Set reviewer availability
      parameters:
        - name: reviewer_id
          in: path
          required: true
          schema:
            type: string
        - name: available
          in: query
          required: true
          schema:
            type: boolean
      responses:
        '200':
          description: Availability updated

  /v1/hitl/reviewers/{reviewer_id}/dashboard:
    get:
      tags: [HITL]
      summary: Get reviewer dashboard
      parameters:
        - name: reviewer_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Dashboard data

  /v1/hitl/reviewers/{reviewer_id}/assignments:
    get:
      tags: [HITL]
      summary: Get reviewer assignments
      parameters:
        - name: reviewer_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Assignments list

  /v1/hitl/escalate:
    post:
      tags: [HITL]
      summary: Manually escalate a ticket
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [ticket_id, reason]
              properties:
                ticket_id:
                  type: string
                reason:
                  type: string
                priority:
                  type: string
                  enum: [critical, high, medium, low]
                tenant_id:
                  type: string
      responses:
        '200':
          description: Escalation created

  /v1/hitl/escalation-policies:
    post:
      tags: [HITL]
      summary: Create an escalation policy
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, rules]
              properties:
                name:
                  type: string
                rules:
                  type: array
                  items:
                    type: object
                include_default_rules:
                  type: boolean
                  default: true
      responses:
        '200':
          description: Policy created

  # ── Governance ───────────────────────────────────────────────
  /v1/governance/dashboard:
    get:
      tags: [Governance]
      summary: Get governance dashboard metrics
      parameters:
        - $ref: '#/components/parameters/TenantId'
      responses:
        '200':
          description: Dashboard metrics
          content:
            application/json:
              schema:
                type: object

  /v1/governance/agents/active:
    get:
      tags: [Governance]
      summary: List active agents
      parameters:
        - $ref: '#/components/parameters/TenantId'
      responses:
        '200':
          description: Active agents list

  /v1/governance/roles:
    get:
      tags: [Governance]
      summary: List all roles
      responses:
        '200':
          description: Roles list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
    post:
      tags: [Governance]
      summary: Create a role
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [role_name, permissions]
              properties:
                role_name:
                  type: string
                permissions:
                  type: array
                  items:
                    type: string
                description:
                  type: string
      responses:
        '201':
          description: Role created

  /v1/governance/roles/assign:
    post:
      tags: [Governance]
      summary: Assign a role to an agent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [agent_id, role_name]
              properties:
                agent_id:
                  type: string
                role_name:
                  type: string
                tenant_id:
                  type: string
      responses:
        '200':
          description: Role assigned

  /v1/governance/roles/{agent_id}/{role_name}:
    delete:
      tags: [Governance]
      summary: Revoke a role from an agent
      parameters:
        - $ref: '#/components/parameters/AgentId'
        - name: role_name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Role revoked

  /v1/governance/permissions/{agent_id}:
    get:
      tags: [Governance]
      summary: Get agent permissions
      parameters:
        - $ref: '#/components/parameters/AgentId'
        - $ref: '#/components/parameters/TenantId'
      responses:
        '200':
          description: Agent permissions

  /v1/governance/permissions/grant:
    post:
      tags: [Governance]
      summary: Grant a permission
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [agent_id, resource, actions]
              properties:
                agent_id:
                  type: string
                resource:
                  type: string
                actions:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Permission granted

  /v1/governance/permissions/{agent_id}/{resource}:
    delete:
      tags: [Governance]
      summary: Revoke a permission
      parameters:
        - $ref: '#/components/parameters/AgentId'
        - name: resource
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Permission revoked

  /v1/governance/permissions/check:
    get:
      tags: [Governance]
      summary: Check if agent has permission
      parameters:
        - name: agent_id
          in: query
          required: true
          schema:
            type: string
        - name: resource
          in: query
          required: true
          schema:
            type: string
        - name: action
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Permission check result
          content:
            application/json:
              schema:
                type: object
                properties:
                  allowed:
                    type: boolean

  /v1/governance/audit:
    get:
      tags: [Governance]
      summary: Query audit logs
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - name: agent_id
          in: query
          schema:
            type: string
        - name: action
          in: query
          schema:
            type: string
        - name: start_time
          in: query
          schema:
            type: string
            format: date-time
        - name: end_time
          in: query
          schema:
            type: string
            format: date-time
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: Audit log entries

  /v1/governance/audit/agent/{agent_id}:
    get:
      tags: [Governance]
      summary: Get audit history for an agent
      parameters:
        - $ref: '#/components/parameters/AgentId'
        - $ref: '#/components/parameters/Limit'
      responses:
        '200':
          description: Agent audit history

  /v1/governance/audit/execution/{execution_id}:
    get:
      tags: [Governance]
      summary: Get audit trail for an execution
      parameters:
        - name: execution_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Execution audit trail

  /v1/governance/audit/human-interactions:
    get:
      tags: [Governance]
      summary: Get human interaction audit logs
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - name: start_time
          in: query
          schema:
            type: string
            format: date-time
        - name: end_time
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Human interaction logs

  /v1/governance/audit/security:
    get:
      tags: [Governance]
      summary: Get security event logs
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - $ref: '#/components/parameters/Limit'
      responses:
        '200':
          description: Security events

  /v1/governance/audit/export:
    get:
      tags: [Governance]
      summary: Export audit logs (JSON or CSV)
      parameters:
        - $ref: '#/components/parameters/TenantId'
        - name: format
          in: query
          schema:
            type: string
            enum: [json, csv]
            default: json
      responses:
        '200':
          description: Exported audit data

  /v1/governance/stats:
    get:
      tags: [Governance]
      summary: Get governance statistics
      parameters:
        - $ref: '#/components/parameters/TenantId'
      responses:
        '200':
          description: Governance stats

  # ── Tenants ──────────────────────────────────────────────────
  /v1/tenants:
    post:
      tags: [Tenants]
      summary: Create a tenant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTenantRequest'
      responses:
        '201':
          description: Tenant created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TenantResponse'
    get:
      tags: [Tenants]
      summary: List tenants
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [active, suspended, pending]
        - name: tier
          in: query
          schema:
            type: string
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: Tenant list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TenantResponse'

  /v1/tenants/{tenant_id}:
    get:
      tags: [Tenants]
      summary: Get tenant details
      parameters:
        - $ref: '#/components/parameters/TenantIdPath'
      responses:
        '200':
          description: Tenant details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TenantResponse'
    put:
      tags: [Tenants]
      summary: Update tenant
      parameters:
        - $ref: '#/components/parameters/TenantIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                tier:
                  type: string
                config:
                  type: object
      responses:
        '200':
          description: Tenant updated
    delete:
      tags: [Tenants]
      summary: Delete tenant
      parameters:
        - $ref: '#/components/parameters/TenantIdPath'
        - name: force
          in: query
          schema:
            type: boolean
            default: false
      responses:
        '204':
          description: Tenant deleted

  /v1/tenants/{tenant_id}/activate:
    post:
      tags: [Tenants]
      summary: Activate a tenant
      parameters:
        - $ref: '#/components/parameters/TenantIdPath'
      responses:
        '200':
          description: Tenant activated

  /v1/tenants/{tenant_id}/suspend:
    post:
      tags: [Tenants]
      summary: Suspend a tenant
      parameters:
        - $ref: '#/components/parameters/TenantIdPath'
        - name: reason
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Tenant suspended

  /v1/tenants/{tenant_id}/usage:
    get:
      tags: [Tenants]
      summary: Get tenant usage metrics
      parameters:
        - $ref: '#/components/parameters/TenantIdPath'
      responses:
        '200':
          description: Usage metrics

  /v1/tenants/{tenant_id}/limits:
    put:
      tags: [Tenants]
      summary: Set custom resource limits
      parameters:
        - $ref: '#/components/parameters/TenantIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                max_agents:
                  type: integer
                max_executions_per_hour:
                  type: integer
                max_concurrent_executions:
                  type: integer
      responses:
        '200':
          description: Limits updated

  /v1/tenants/{tenant_id}/api-key:
    post:
      tags: [Tenants]
      summary: Set tenant API key
      parameters:
        - $ref: '#/components/parameters/TenantIdPath'
        - name: api_key_hash
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: API key set

  /v1/tenants/stats/overview:
    get:
      tags: [Tenants]
      summary: Tenant statistics overview
      responses:
        '200':
          description: Tenant stats

  # ── Webhooks ─────────────────────────────────────────────────
  /v1/webhooks/generic:
    post:
      tags: [Webhooks]
      summary: Receive a generic webhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookPayload'
      responses:
        '202':
          description: Webhook accepted

  /v1/webhooks/zendesk:
    post:
      tags: [Webhooks]
      summary: Receive a Zendesk webhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '202':
          description: Webhook accepted

  /v1/webhooks/slack:
    post:
      tags: [Webhooks]
      summary: Receive a Slack webhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '202':
          description: Webhook accepted

  /v1/webhooks/jira:
    post:
      tags: [Webhooks]
      summary: Receive a Jira webhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '202':
          description: Webhook accepted

  /v1/webhooks/stats:
    get:
      tags: [Webhooks]
      summary: Get webhook and activity stream stats
      responses:
        '200':
          description: Webhook stats

  # ── Analytics ────────────────────────────────────────────────
  /v1/analytics/escalations:
    get:
      tags: [Analytics]
      summary: Get escalation analytics
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: query
          schema:
            type: string
        - name: start_time
          in: query
          schema:
            type: integer
          description: Unix timestamp
        - name: end_time
          in: query
          schema:
            type: integer
          description: Unix timestamp
      responses:
        '200':
          description: Escalation analytics
        '403':
          description: Admin only

  /v1/analytics/escalations/by-agent:
    get:
      tags: [Analytics]
      summary: Escalations aggregated by agent
      security:
        - BearerAuth: []
      parameters:
        - name: agent_id
          in: query
          schema:
            type: string
        - name: start_time
          in: query
          schema:
            type: integer
        - name: end_time
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: By-agent escalation data

  /v1/analytics/escalations/by-category:
    get:
      tags: [Analytics]
      summary: Escalations aggregated by category
      security:
        - BearerAuth: []
      parameters:
        - name: category
          in: query
          schema:
            type: string
        - name: start_time
          in: query
          schema:
            type: integer
        - name: end_time
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: By-category escalation data

  /report_escalation:
    post:
      tags: [Analytics]
      summary: Report an escalation event
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReportEscalationRequest'
      responses:
        '200':
          description: Escalation recorded

  # ── Compliance ───────────────────────────────────────────────
  /v1/compliance/gdpr_delete:
    post:
      tags: [Compliance]
      summary: GDPR data deletion (admin only)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_id]
              properties:
                user_id:
                  type: string
      responses:
        '200':
          description: User data deleted
        '403':
          description: Admin only

  /v1/compliance/ccpa_optout:
    post:
      tags: [Compliance]
      summary: CCPA opt-out of data sale (admin only)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_id]
              properties:
                user_id:
                  type: string
      responses:
        '200':
          description: Opt-out recorded
        '403':
          description: Admin only

  # ── Observability ────────────────────────────────────────────
  /metrics:
    get:
      tags: [Observability]
      summary: Prometheus metrics
      responses:
        '200':
          description: Prometheus text format
          content:
            text/plain:
              schema:
                type: string

  # ── Voice I/O ──────────────────────────────────────────────
  /v1/voice/transcribe:
    post:
      tags: [Voice]
      summary: Speech-to-text transcription (Whisper)
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
                  description: Audio file (mp3, wav, webm, ogg, flac, m4a, mp4)
                language:
                  type: string
                  description: ISO-639-1 language hint
                prompt:
                  type: string
                  description: Transcription style prompt
      responses:
        '200':
          description: Transcription result
          content:
            application/json:
              schema:
                type: object
                properties:
                  text:
                    type: string
                  language:
                    type: string
                  duration_seconds:
                    type: number
                  segments:
                    type: array
                    items:
                      type: object
                  processing_time_ms:
                    type: number
        '400':
          description: Invalid audio format or file too large
        '502':
          description: Whisper API error
        '503':
          description: Voice features disabled

  /v1/voice/synthesize:
    post:
      tags: [Voice]
      summary: Text-to-speech synthesis (OpenAI TTS)
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [text]
              properties:
                text:
                  type: string
                  description: Text to synthesize (max 4096 chars)
                voice:
                  type: string
                  enum: [alloy, echo, fable, onyx, nova, shimmer]
                  default: nova
                speed:
                  type: number
                  minimum: 0.25
                  maximum: 4.0
                  default: 1.0
                response_format:
                  type: string
                  enum: [mp3, opus, aac, flac, wav, pcm]
                  default: mp3
      responses:
        '200':
          description: Audio stream
          content:
            audio/mpeg:
              schema:
                type: string
                format: binary
        '400':
          description: Invalid parameters
        '502':
          description: TTS API error

  /v1/voice/chat:
    post:
      tags: [Voice]
      summary: Full voice chat pipeline (audio → RAG → audio)
      description: |
        Transcribes uploaded audio, sends text to RAG chain, synthesizes response as audio.
        Returns both text and base64-encoded audio.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
                  description: Audio file with customer question
                language:
                  type: string
                  description: ISO-639-1 language hint
                voice:
                  type: string
                  default: nova
                text_only:
                  type: boolean
                  default: false
                  description: Return text only (skip audio synthesis)
      responses:
        '200':
          description: Voice chat response
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_text:
                    type: string
                  reply_text:
                    type: string
                  audio_base64:
                    type: string
                    nullable: true
                  audio_format:
                    type: string
                    nullable: true
                  sources:
                    type: array
                    items:
                      $ref: '#/components/schemas/SourceDocument'

  /v1/voice/status:
    get:
      tags: [Voice]
      summary: Check voice feature availability
      responses:
        '200':
          description: Voice status
          content:
            application/json:
              schema:
                type: object
                properties:
                  enabled:
                    type: boolean
                  supported_audio_formats:
                    type: array
                    items:
                      type: string
                  supported_voices:
                    type: array
                    items:
                      type: string

  # ── Cost Tracking ──────────────────────────────────────────
  /v1/analytics/costs:
    get:
      tags: [Cost Tracking]
      summary: Get LLM cost dashboard
      description: Returns current month spend, budget status, per-model and per-tenant breakdowns, daily trend, and recent alerts.
      responses:
        '200':
          description: Cost dashboard
          content:
            application/json:
              schema:
                type: object
                properties:
                  period:
                    type: string
                  current_spend_usd:
                    type: number
                  monthly_budget_usd:
                    type: number
                  budget_remaining_usd:
                    type: number
                  budget_utilization_pct:
                    type: number
                  total_requests:
                    type: integer
                  total_tokens:
                    type: integer
                  by_model:
                    type: object
                  by_tenant:
                    type: object
                  daily_trend:
                    type: object
                  recent_alerts:
                    type: array
                    items:
                      type: object

  /v1/analytics/costs/tenant:
    get:
      tags: [Cost Tracking]
      summary: Get per-tenant cost breakdown
      parameters:
        - name: tenant_id
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Tenant cost data
          content:
            application/json:
              schema:
                type: object
                properties:
                  tenant_id:
                    type: string
                  total_requests:
                    type: integer
                  total_tokens:
                    type: integer
                  total_cost_usd:
                    type: number

  /v1/analytics/costs/record:
    post:
      tags: [Cost Tracking]
      summary: Record an LLM usage event
      parameters:
        - name: model
          in: query
          required: true
          schema:
            type: string
        - name: prompt_tokens
          in: query
          required: true
          schema:
            type: integer
        - name: completion_tokens
          in: query
          required: true
          schema:
            type: integer
        - name: provider
          in: query
          schema:
            type: string
            default: openai
        - name: tenant_id
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Usage recorded
          content:
            application/json:
              schema:
                type: object
                properties:
                  recorded:
                    type: boolean
                  estimated_cost_usd:
                    type: number
                  total_tokens:
                    type: integer

  # ── A2A Protocol ───────────────────────────────────────────
  /.well-known/agent.json:
    get:
      tags: [A2A Protocol]
      summary: Agent Card discovery
      description: Returns the A2A Agent Card describing this agent's identity, skills, and capabilities.
      responses:
        '200':
          description: Agent Card
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                  description:
                    type: string
                  url:
                    type: string
                  version:
                    type: string
                  protocolVersion:
                    type: string
                  skills:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        name:
                          type: string
                        description:
                          type: string
                        tags:
                          type: array
                          items:
                            type: string
                  capabilities:
                    type: object

  /a2a:
    post:
      tags: [A2A Protocol]
      summary: A2A JSON-RPC 2.0 task dispatch
      description: |
        Accepts JSON-RPC 2.0 requests per the Google A2A protocol spec.
        Supported methods: tasks/send, tasks/get, tasks/cancel.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [jsonrpc, method]
              properties:
                jsonrpc:
                  type: string
                  enum: ['2.0']
                id:
                  type: string
                method:
                  type: string
                  enum: ['tasks/send', 'tasks/get', 'tasks/cancel']
                params:
                  type: object
      responses:
        '200':
          description: JSON-RPC 2.0 response
          content:
            application/json:
              schema:
                type: object
                properties:
                  jsonrpc:
                    type: string
                  id:
                    type: string
                  result:
                    type: object
                  error:
                    type: object

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    TenantId:
      name: tenant_id
      in: query
      schema:
        type: string
    TenantIdPath:
      name: tenant_id
      in: path
      required: true
      schema:
        type: string
    AgentId:
      name: agent_id
      in: path
      required: true
      schema:
        type: string
    RequestId:
      name: request_id
      in: path
      required: true
      schema:
        type: string
    Limit:
      name: limit
      in: query
      schema:
        type: integer
        default: 50
    Offset:
      name: offset
      in: query
      schema:
        type: integer
        default: 0

  responses:
    RateLimited:
      description: Rate limit exceeded (10 req/min/IP)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    TicketContext:
      type: object
      properties:
        ticket_id:
          type: string
        user_id:
          type: string
        content:
          type: string
        user_query:
          type: string

    SuggestedResponse:
      type: object
      properties:
        reply_text:
          type: string
        sources:
          type: array
          items:
            $ref: '#/components/schemas/SourceDocument'
        error:
          $ref: '#/components/schemas/ErrorResponse'

    SourceDocument:
      type: object
      properties:
        url:
          type: string
        excerpt:
          type: string
        confidence:
          type: number
          format: float
        last_updated:
          type: string

    IngestResponse:
      type: object
      properties:
        status:
          type: string
        chunks_created:
          type: integer
        document_id:
          type: string

    CreateAgentRequest:
      type: object
      required: [blueprint_name, tenant_id]
      properties:
        blueprint_name:
          type: string
        tenant_id:
          type: string
        config:
          type: object

    AgentResponse:
      type: object
      properties:
        agent_id:
          type: string
        blueprint_name:
          type: string
        tenant_id:
          type: string
        status:
          type: string
        created_at:
          type: string
          format: date-time
        config:
          type: object

    BlueprintResponse:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        version:
          type: string
        tools:
          type: array
          items:
            type: string
        default_config:
          type: object

    ExecuteAgentRequest:
      type: object
      required: [input_data]
      properties:
        input_data:
          type: object
        tenant_id:
          type: string

    ExecutionResponse:
      type: object
      properties:
        execution_id:
          type: string
        agent_id:
          type: string
        result:
          type: object
        duration_ms:
          type: number
        status:
          type: string

    CreateTenantRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        tier:
          type: string
          enum: [free, starter, professional, enterprise]
        config:
          type: object

    TenantResponse:
      type: object
      properties:
        tenant_id:
          type: string
        name:
          type: string
        tier:
          type: string
        status:
          type: string
        created_at:
          type: string
          format: date-time
        usage:
          type: object

    WebhookPayload:
      type: object
      required: [source, event_type, data]
      properties:
        source:
          type: string
        event_type:
          type: string
        data:
          type: object
        tenant_id:
          type: string

    ReportEscalationRequest:
      type: object
      properties:
        user_id:
          type: string
        text:
          type: string
        confidence:
          type: number
        source_url:
          type: string

    ErrorResponse:
      type: object
      properties:
        error_type:
          type: string
        message:
          type: string
        retryable:
          type: boolean
        documentation:
          type: string
